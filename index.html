<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Local PDF Editor — Fixed (Image & Embedding Robust)</title>
  <style>
    :root{--bg:#0b1020;--panel:#11162a;--panel-2:#0f1430;--text:#e8eefc;--muted:#a2b0d1;--accent:#6ea8fe}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,var(--bg),#060a18);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Inter,sans-serif}
    header{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;background:linear-gradient(180deg,var(--panel),var(--panel-2));border-bottom:1px solid #1a2244;position:sticky;top:0;z-index:30}
    header h1{font-size:16px;margin:0;font-weight:700}
    .wrap{display:grid;grid-template-columns:320px 1fr;min-height:calc(100vh - 52px)}
    aside{padding:1rem}
    .group{background:#0d132a;border-radius:10px;padding:.6rem;border:1px solid #1a2244;margin-bottom:.8rem}
    .row{display:flex;gap:.5rem;align-items:center}
    .small{font-size:12px;color:#a2b0d1}
    .page{position:relative;margin:1rem auto;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.35);border:1px solid #11194a;background:#0a0f24}
    canvas.overlay{position:absolute;left:0;top:0}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.6);z-index:100}
    .panel{background:#07102a;padding:1rem;border-radius:8px;border:1px solid #1a2244}
    button{padding:.4rem .7rem;border-radius:6px;background:#182040;color:var(--text);border:1px solid #22306a}
    button.ok{background:#00c16a}
  </style>

  <!-- REQUIRED LOCAL LIBRARIES:
       ./lib/pdfjs/pdf.js
       ./lib/pdfjs/pdf.worker.js
       ./lib/pdf-lib.min.js
     Make sure those files exist and are served by your local server.
  -->
  <script src="./lib/pdfjs/pdf.js"></script>
  <script>if(window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = './lib/pdfjs/pdf.worker.js';</script>
  <script src="./lib/pdf-lib.min.js"></script>
</head>
<body>
  <header><h1>Local PDF Editor — Fixed</h1><div style="margin-left:auto" class="small">Open DevTools (F12) if something fails</div></header>

  <div class="wrap">
    <aside>
      <div class="group">
        <h3>Files & Run</h3>
        <div class="small">1) Put pdf.js and pdf.worker.js under <code>./lib/pdfjs/</code> and pdf-lib under <code>./lib/</code>.<br>2) Run via local server: <code>python -m http.server 8080</code> and open <code>http://localhost:8080</code>.</div>
      </div>

      <div class="group">
        <h3>Quick Actions</h3>
        <div class="row"><input id="fileInput" type="file" accept="application/pdf"/></div>
        <div class="row" style="margin-top:.5rem"><button id="newPdf">New PDF</button><button id="mergePdf">Merge PDFs</button></div>
      </div>

      <div class="group">
        <h3>Images / Signature</h3>
        <div class="row"><input id="imgInput" type="file" accept="image/*"/></div>
        <div class="row" style="margin-top:.5rem"><button id="openSigPad">Draw Signature</button><input id="sigInput" type="file" accept="image/*"/></div>
        <div class="small">Uploads are stored as data URLs (base64) to ensure embedding works in all browsers.</div>
      </div>

      <div class="group">
        <h3>Save & Export</h3>
        <div class="row"><button id="download" class="ok">Download Edited PDF</button><button id="saveToDrive">Prepare for Drive</button></div>
        <div class="small">If something fails, open DevTools → Console and paste error here.</div>
      </div>

      <div class="group">
        <h3>Status</h3>
        <pre id="log" style="height:120px;overflow:auto;background:#07102a;padding:.5rem;border-radius:6px;border:1px solid #1a2244"></pre>
      </div>
    </aside>

    <main>
      <div id="viewer"></div>
    </main>
  </div>

  <!-- Signature modal -->
  <div id="sigModal" class="modal"><div class="panel"><h3>Draw Signature</h3><canvas id="sigCanvas" width="400" height="120" style="border:1px solid #22306a;background:#07102a;display:block;margin-bottom:.5rem"></canvas><div class="row"><button id="sigClear">Clear</button><button id="sigSave" class="ok">Save</button><button id="sigClose">Close</button></div></div></div>

<script>
(async function(){
  // small logger
  const logEl = document.getElementById('log'); function log(...args){ console.log(...args); logEl.textContent += args.map(a=> typeof a==='object' ? JSON.stringify(a) : String(a)).join(' ') + '
'; logEl.scrollTop = logEl.scrollHeight; }

  // quick checks
  if(!window.pdfjsLib) log('ERROR: pdfjsLib not found. Check ./lib/pdfjs/pdf.js is loaded.');
  if(!window.PDFLib) log('ERROR: PDFLib not found. Check ./lib/pdf-lib.min.js is loaded.');

  // elements
  const fileInput = document.getElementById('fileInput');
  const imgInput = document.getElementById('imgInput');
  const sigInput = document.getElementById('sigInput');
  const newPdfBtn = document.getElementById('newPdf');
  const mergePdfBtn = document.getElementById('mergePdf');
  const downloadBtn = document.getElementById('download');
  const saveToDriveBtn = document.getElementById('saveToDrive');
  const viewer = document.getElementById('viewer');
  const sigModal = document.getElementById('sigModal');
  const sigCanvas = document.getElementById('sigCanvas');
  const sigClear = document.getElementById('sigClear');
  const sigSave = document.getElementById('sigSave');
  const sigClose = document.getElementById('sigClose');
  const openSigPad = document.getElementById('openSigPad');

  let pdfDoc = null, pdfBytesOriginal = null, currentPage = 1, scale = 1.0;
  const state = { pages: new Map() };
  function ensurePageState(n){ if(!state.pages.has(n)) state.pages.set(n,{paths:[],texts:[],stamps:[]}); return state.pages.get(n); }

  // store last uploaded image as data URL (base64) to avoid blob/fetch issues
  let lastStamp = null;
  imgInput.addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{ lastStamp = { dataUrl: reader.result, name: f.name, w:140, h:140 }; log('Image read as data URL'); alert('Image ready: choose Image tool and click page to place.'); };
    reader.onerror = (err)=>{ log('FileReader error',err); alert('Failed to read image'); };
    reader.readAsDataURL(f);
  });
  sigInput.addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ lastStamp = { dataUrl: r.result, name:f.name, w:180, h:80 }; alert('Signature ready. Select Image tool to place.'); }; r.readAsDataURL(f); });

  // signature pad
  const sctx = sigCanvas.getContext('2d'); function clearSig(){ sctx.fillStyle='#07102a'; sctx.fillRect(0,0,sigCanvas.width,sigCanvas.height); sctx.strokeStyle='#fff'; sctx.lineWidth=2; sctx.lineCap='round'; }
  clearSig(); let sDrawing=false; sigCanvas.addEventListener('pointerdown',(e)=>{ sDrawing=true; sctx.beginPath(); sctx.moveTo(e.offsetX,e.offsetY); }); window.addEventListener('pointermove',(e)=>{ if(!sDrawing) return; if(e.target===sigCanvas){ sctx.lineTo(e.offsetX,e.offsetY); sctx.stroke(); } }); window.addEventListener('pointerup',()=> sDrawing=false);
  openSigPad.addEventListener('click', ()=> sigModal.style.display='flex'); sigClose.addEventListener('click', ()=> sigModal.style.display='none'); sigClear.addEventListener('click', ()=> clearSig()); sigSave.addEventListener('click', ()=>{ const data = sigCanvas.toDataURL('image/png'); lastStamp = { dataUrl: data, name: 'signature.png', w:220, h:80 }; sigModal.style.display='none'; alert('Signature saved. Select Image tool then click page to place.'); });

  // minimal tool: image placement and simple render of first page to ensure libs working
  async function loadFile(file){ try{ pdfBytesOriginal = await file.arrayBuffer(); pdfDoc = await pdfjsLib.getDocument({data: pdfBytesOriginal}).promise; currentPage=1; state.pages.clear(); await renderPage(); log('PDF loaded, pages:', pdfDoc.numPages); }catch(e){ log('Error loading PDF:', e); alert('Cannot load PDF. See console.'); } }

  async function renderPage(){ viewer.innerHTML=''; if(!pdfDoc){ viewer.innerHTML = '<div class="small">No PDF loaded</div>'; return; } try{ const page = await pdfDoc.getPage(currentPage); const viewport = page.getViewport({scale}); const container = document.createElement('div'); container.className='page'; container.style.width = viewport.width+'px'; container.style.height = viewport.height+'px'; const renderCanvas = document.createElement('canvas'); renderCanvas.width = viewport.width; renderCanvas.height = viewport.height; const overlay = document.createElement('canvas'); overlay.className='overlay'; overlay.width = viewport.width; overlay.height = viewport.height; container.appendChild(renderCanvas); container.appendChild(overlay); viewer.appendChild(container); await page.render({canvasContext: renderCanvas.getContext('2d'), viewport}).promise; // draw any stamps/texts for page
      const st = ensurePageState(currentPage);
      const octx = overlay.getContext('2d'); octx.clearRect(0,0,overlay.width,overlay.height);
      if(st.stamps){ for(const s of st.stamps){ if(s.dataUrl){ const img = new Image(); img.src = s.dataUrl; await new Promise(r=> img.onload = r); // draw with PDF->canvas mapping: x,y are PDF user coords, origin bottom-left
            const cx = s.x * scale; const cy = overlay.height - (s.y * scale) - (s.h*scale); octx.drawImage(img, cx, cy, s.w*scale, s.h*scale); } }
      }
    }catch(e){ log('renderPage error',e); }
  }

  // Convert dataURL to Uint8Array (for embedding into PDF via pdf-lib)
  function dataURLToUint8Array(dataURL){ const arr = dataURL.split(','); if(arr.length<2) throw new Error('Bad dataURL'); const mime = arr[0].match(/:(.*?);/)[1]; const bstr = atob(arr[1]); const n = bstr.length; const u8 = new Uint8Array(n); for(let i=0;i<n;i++) u8[i] = bstr.charCodeAt(i); return u8; }

  // place stamp on click: (simple single-page demo)
  viewer.addEventListener('click',(e)=>{
    if(!lastStamp) return; // ignore if clicked outside page area
    const pageElem = e.target.closest('.page'); if(!pageElem) return;
    // compute click relative to page
    const rect = pageElem.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; // canvas coords
    // convert to PDF user coords
    const pdfX = x / scale; const pdfY = (pageElem.querySelector('canvas').height - y) / scale;
    const st = ensurePageState(currentPage); const stamp = { x: pdfX, y: pdfY, w: lastStamp.w, h: lastStamp.h, dataUrl: lastStamp.dataUrl };
    st.stamps.push(stamp); log('Placed stamp at',stamp); renderPage();
  });

  // Build edited PDF bytes (embed stamps/texts)
  async function buildEditedPdfBytes(){ if(!pdfBytesOriginal) throw new Error('No PDF loaded'); const { PDFDocument, rgb, StandardFonts } = PDFLib; const doc = await PDFDocument.load(pdfBytesOriginal); const font = await doc.embedFont(StandardFonts.Helvetica);
    for(let i=0;i<doc.getPageCount();i++){ const pnum = i+1; const page = doc.getPage(i); const {width,height} = page.getSize(); const st = state.pages.get(pnum); if(!st) continue; // stamps
      if(st.stamps && st.stamps.length){ for(const s of st.stamps){ try{ let bytes;
            if(s.dataUrl){ bytes = dataURLToUint8Array(s.dataUrl); }
            else { // last resort: try fetch
              const resp = await fetch(s.dataUrl); bytes = new Uint8Array(await resp.arrayBuffer()); }
            let img; try{ img = await doc.embedPng(bytes); }catch(e){ img = await doc.embedJpg(bytes); }
            page.drawImage(img,{x:s.x,y:s.y,width:s.w,height:s.h});
          }catch(e){ log('Failed embedding stamp', e); }
      } }
      // TODO: embed paths/texts similarly if present
    }
    return await doc.save(); }

  // UI bindings
  fileInput.addEventListener('change',(e)=>{ const f = e.target.files[0]; if(f) loadFile(f); });
  newPdfBtn.addEventListener('click', async ()=>{ const { PDFDocument } = PDFLib; const d = await PDFDocument.create(); d.addPage([595.28,841.89]); const b = await d.save(); pdfBytesOriginal = b; pdfDoc = await pdfjsLib.getDocument({data:b}).promise; state.pages.clear(); currentPage=1; await renderPage(); log('Created new PDF'); });
  mergePdfBtn.addEventListener('click', async ()=>{ const input = document.createElement('input'); input.type='file'; input.multiple=true; input.accept='application/pdf'; input.onchange = async ()=>{ try{ const { PDFDocument } = PDFLib; const out = await PDFDocument.create(); for(const f of input.files){ const bytes = await f.arrayBuffer(); const donor = await PDFDocument.load(bytes); const pages = await out.copyPages(donor, donor.getPageIndices()); pages.forEach(p=> out.addPage(p)); } const merged = await out.save(); pdfBytesOriginal = merged; pdfDoc = await pdfjsLib.getDocument({data:merged}).promise; state.pages.clear(); currentPage=1; await renderPage(); log('Merged PDFs'); }catch(e){ log('Merge error',e);} }; input.click(); });

  downloadBtn.addEventListener('click', async ()=>{ try{ const bytes = await buildEditedPdfBytes(); const blob = new Blob([bytes],{type:'application/pdf'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='edited.pdf'; a.click(); URL.revokeObjectURL(url); log('Downloaded edited PDF'); }catch(e){ log('Download/build error', e); alert('Failed to build PDF — see console'); } });

  saveToDriveBtn.addEventListener('click', async ()=>{ try{ const bytes = await buildEditedPdfBytes(); const blob = new Blob([bytes],{type:'application/pdf'}); const url = URL.createObjectURL(blob); window.open(url,'_blank'); alert('Opened PDF in new tab. Upload to Drive from there.'); }catch(e){ log('Prepare Drive failed', e); } });

  // helper to show console errors to user
  window.addEventListener('error', (ev)=>{ log('Window error:', ev.message, ev.filename + ':' + ev.lineno); });
  window.addEventListener('unhandledrejection', (ev)=>{ log('Unhandled promise rejection:', ev.reason); });

  log('Editor loaded — follow the "Files & Run" instructions in left panel.');
})();
</script>
</body>
</html>
